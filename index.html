<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Análisis GANE 2025 - Tablero de Grupos Armados No Estatales</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"
    />
    <style>
      :root {
        /* Paleta oficial OCHA */
        --ocha-blue: #1F69B3;
        --ocha-light-blue: #59B9E3;
        --ocha-dark-blue: #1B5A97;
        --ocha-red: #E56A54;
        --ocha-orange: #F36D25;
        --ocha-yellow: #FFC107;
        --ocha-green: #009959;
        --ocha-teal: #00827D;
        --ocha-purple: #9467BD; 
        --ocha-grey: #6C757D;
        --ocha-light-grey: #E9ECEF;
        
        /* Colores para grupos armados - más contrastantes y coordinados con OCHA */
        --color-delictivo: #F36D25;      /* Naranja OCHA */
        --color-eln: #1F69B3;           /* Azul OCHA */
        --color-farc: #009959;          /* Verde OCHA */
        --color-dfarc: #FFC107;         /* Amarillo OCHA */
        --color-paramilitares: #E56A54; /* Rojo OCHA */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #F5F7FA;
        color: #333;
        line-height: 1.6;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 25px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      .header-title {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .header-title h1 {
        color: var(--ocha-blue);
        font-size: 2em;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .header-stats {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .header-stat {
        padding: 6px 15px;
        background: var(--ocha-blue);
        color: white;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .ocha-logo {
        height: 55px;
        margin-left: 15px;
      }

      .header-actions {
        display: flex;
        gap: 12px;
      }

      .header-button {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        background: var(--ocha-grey);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.2s;
      }

      .header-button:hover {
        background: var(--ocha-dark-blue);
        transform: translateY(-2px);
      }

      .main-kpis {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        margin-bottom: 35px;
      }

      .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        position: relative;
        overflow: hidden;
        transition: transform 0.3s;
      }

      .kpi-card:hover {
        transform: translateY(-5px);
      }

      .kpi-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 1.4em;
        color: var(--ocha-blue);
        opacity: 0.15;
      }

      .kpi-title {
        color: var(--ocha-grey);
        font-size: 1em;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .kpi-value {
        font-size: 2.4em;
        font-weight: 700;
        color: var(--ocha-blue);
        margin-bottom: 8px;
      }

      .kpi-subvalue {
        font-size: 0.9em;
        color: var(--ocha-grey);
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
        margin-bottom: 35px;
      }

      #map {
        background: white;
        border-radius: 12px;
        height: 600px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      .filters-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      .filter-group {
        margin-bottom: 25px;
      }

      .filter-group:last-child {
        margin-bottom: 0;
      }

      .filter-label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #444;
        font-size: 1.05em;
      }

      .filter-select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s;
      }

      .filter-select:focus {
        border-color: var(--ocha-blue);
        outline: none;
      }

      .multiselect-container {
        position: relative;
      }

      .multiselect-dropdown {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1em;
        transition: all 0.3s;
      }

      .multiselect-dropdown:hover {
        border-color: var(--ocha-blue);
      }

      .multiselect-dropdown::after {
        content: "\f107";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        color: var(--ocha-blue);
      }

      .multiselect-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 5px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .multiselect-option {
        padding: 10px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s;
      }

      .multiselect-option:hover {
        background: var(--ocha-light-grey);
      }

      .multiselect-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--ocha-blue);
      }

      .severity-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .group-button {
        padding: 12px 18px;
        border: 2px solid;
        border-radius: 8px;
        cursor: pointer;
        background: white;
        font-weight: 600;
        transition: all 0.3s ease;
        flex: 1;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 120px;
      }

      .group-button[data-value="delictivo"] {
        border-color: var(--color-delictivo);
        color: var(--color-delictivo);
      }
      
      .group-button[data-value="eln"] {
        border-color: var(--color-eln);
        color: var(--color-eln);
      }
      
      .group-button[data-value="farc"] {
        border-color: var(--color-farc);
        color: var(--color-farc);
      }
      
      .group-button[data-value="dfarc"] {
        border-color: var(--color-dfarc);
        color: var(--color-dfarc);
      }
      
      .group-button[data-value="paramilitares"] {
        border-color: var(--color-paramilitares);
        color: var(--color-paramilitares);
      }

      .group-button.selected[data-value="delictivo"] {
        background: var(--color-delictivo);
        color: white;
      }
      
      .group-button.selected[data-value="eln"] {
        background: var(--color-eln);
        color: white;
      }
      
      .group-button.selected[data-value="farc"] {
        background: var(--color-farc);
        color: white;
      }
      
      .group-button.selected[data-value="dfarc"] {
        background: var(--color-dfarc);
        color: white;
      }
      
      .group-button.selected[data-value="paramilitares"] {
        background: var(--color-paramilitares);
        color: white;
      }

      .range-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        margin: 20px 0;
      }

      .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--ocha-blue);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .range-values {
        display: flex;
        justify-content: space-between;
        color: var(--ocha-grey);
        font-size: 0.95em;
        font-weight: 500;
      }

      .section-title {
        margin: 40px 0 25px 0;
        color: var(--ocha-blue);
        font-size: 1.6em;
        font-weight: 700;
        position: relative;
        padding-bottom: 10px;
      }

      .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 4px;
        background: var(--ocha-blue);
        border-radius: 2px;
      }

      .sectoral-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 25px;
        margin-top: 25px;
      }

      .sector-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        transition: transform 0.3s;
      }

      .sector-card:hover {
        transform: translateY(-5px);
      }

      .sector-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .sector-icon {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        border-radius: 50%;
        font-size: 1.2em;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .sector-title {
        font-weight: 700;
        color: #333;
        font-size: 1.1em;
      }

      .sector-stats {
        display: grid;
        gap: 15px;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .stat-label {
        color: var(--ocha-grey);
        font-size: 0.95em;
        font-weight: 500;
      }

      .stat-value {
        font-weight: 700;
        color: #333;
        font-size: 1.05em;
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 25px;
        margin-top: 25px;
      }

      .chart-box {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        height: 380px;
        position: relative;
        transition: transform 0.3s;
      }

      .chart-box:hover {
        transform: translateY(-5px);
      }

      .chart-title {
        color: #333;
        font-size: 1.15em;
        margin-bottom: 20px;
        font-weight: 700;
        text-align: center;
      }

      .chart-box canvas {
        width: 100% !important;
        height: calc(100% - 50px) !important;
      }

      .leaflet-popup-content {
        margin: 16px;
        font-size: 1em;
      }

      .municipality-popup {
        max-width: 350px;
      }

      .municipality-popup h3 {
        margin-bottom: 15px;
        color: var(--ocha-blue);
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        font-size: 1.2em;
        font-weight: 700;
      }

      .popup-stats {
        margin-bottom: 20px;
      }

      .popup-stats div {
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .popup-stats strong {
        font-weight: 600;
        color: #444;
      }

      .map-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 250px;
      }

      .map-legend h4 {
        margin-bottom: 10px;
        font-size: 0.9em;
        font-weight: 600;
        color: #444;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.85em;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .legend-label {
        color: #555;
      }

      @media (max-width: 1200px) {
        .main-kpis {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .charts-container {
          grid-template-columns: 1fr;
          grid-template-rows: repeat(6, 1fr);
        }
      }

      @media (max-width: 900px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .main-kpis {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 600px) {
        .main-kpis {
          grid-template-columns: 1fr;
        }
        
        .header {
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }
        
        .header-title {
          align-items: center;
        }
        
        .section-title {
          text-align: center;
        }
        
        .section-title::after {
          left: 50%;
          transform: translateX(-50%);
        }
      }

      /* Estilos para tags y mensajes */
      .tag {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 30px;
        font-size: 0.9em;
        color: white;
        margin: 3px;
        font-weight: 500;
      }
      
      .tag-delictivo {
        background-color: var(--color-delictivo);
      }
      
      .tag-eln {
        background-color: var(--color-eln);
      }
      
      .tag-farc {
        background-color: var(--color-farc);
      }
      
      .tag-dfarc {
        background-color: var(--color-dfarc);
      }
      
      .tag-paramilitares {
        background-color: var(--color-paramilitares);
      }

      .message-container {
        margin-top: 50px;
        margin-bottom: 35px;
      }
      
      .message-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
      }
      
      .key-message {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        position: relative;
        overflow: hidden;
        transition: transform 0.3s;
      }
      
      .key-message:hover {
        transform: translateY(-5px);
      }
      
      .key-message h3 {
        margin-bottom: 15px;
        font-size: 1.15em;
        color: #333;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .key-message p {
        font-size: 1em;
        color: #555;
        line-height: 1.6;
      }
      
      .key-message.alert {
        border-left: 4px solid var(--ocha-red);
      }
      
      .key-message.warning {
        border-left: 4px solid var(--ocha-orange);
      }
      
      .key-message.info {
        border-left: 4px solid var(--ocha-blue);
      }
      
      .key-message.success {
        border-left: 4px solid var(--ocha-green);
      }

      .message-icon {
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
      }
      
      .message-icon.alert {
        background-color: var(--ocha-red);
      }
      
      .message-icon.warning {
        background-color: var(--ocha-orange);
      }
      
      .message-icon.info {
        background-color: var(--ocha-blue);
      }
      
      .message-icon.success {
        background-color: var(--ocha-green);
      }

      /* Estilos para la leyenda de priorización */
      .priority-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 0.8em;
        margin-right: 6px;
      }
      
      .priority-1 {
        background-color: var(--ocha-red);
      }
      
      .priority-2 {
        background-color: var(--ocha-orange);
      }
      
      .priority-3 {
        background-color: var(--ocha-yellow);
        color: #333;
      }
      
      .priority-4 {
        background-color: var(--ocha-green);
      }

      .footer {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        margin-top: 50px;
        padding: 25px;
        text-align: center;
      }
      
      .footer-logo {
        margin-bottom: 15px;
      }
      
      .footer-logo img {
        height: 40px;
      }
      
      .footer-info {
        margin-bottom: 15px;
      }
      
      .footer-title {
        font-weight: 700;
        color: var(--ocha-blue);
        font-size: 1.1em;
        margin-bottom: 5px;
      }
      
      .footer-details {
        font-size: 0.9em;
        color: var(--ocha-grey);
      }
      
      .footer-source {
        font-style: italic;
      }
      
      .footer-links {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      
      .footer-link {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--ocha-blue);
        text-decoration: none;
        padding: 5px 10px;
        border-radius: 6px;
        transition: background-color 0.3s;
        font-size: 0.95em;
        font-weight: 500;
      }
      
      .footer-link:hover {
        background-color: rgba(31, 105, 179, 0.1);
      }
    </style>
  </head>

  <body>
    <div class="dashboard-container">
      <header class="header">
        <div class="header-title">
          <h1>Grupos Armados No Estatales (GANE) 2025</h1>
          <div class="header-stats">
            <div class="header-stat">Estado Zulia</div>
            <div class="header-stat">OCHA</div>
            <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="Logo OCHA" class="ocha-logo">
          </div>
        </div>
        <div class="header-actions">
          <button class="header-button" onclick="printDashboard()">
            <i class="fas fa-print"></i> Imprimir
          </button>
          <button class="header-button" onclick="exportData()">
            <i class="fas fa-download"></i> Exportar
          </button>
        </div>
      </header>

      <div class="main-kpis">
        <div class="kpi-card">
          <i class="fas fa-map kpi-icon"></i>
          <div class="kpi-title">Territorio GANE</div>
          <div class="kpi-value" id="total-territory">69,031</div>
          <div class="kpi-subvalue">km²</div>
        </div>
        <div class="kpi-card">
          <i class="fas fa-map-marker-alt kpi-icon"></i>
          <div class="kpi-title">Municipios</div>
          <div class="kpi-value" id="total-municipalities">15</div>
          <div class="kpi-subvalue">con presencia GANE</div>
        </div>
        <div class="kpi-card">
          <i class="fas fa-users kpi-icon"></i>
          <div class="kpi-title">Población Total</div>
          <div class="kpi-value" id="total-population">1,286,208</div>
          <div class="kpi-subvalue">habitantes en zonas afectadas</div>
        </div>
        <div class="kpi-card">
          <i class="fas fa-hand-holding-heart kpi-icon"></i>
          <div class="kpi-title">Organizaciones Humanitarias</div>
          <div class="kpi-value" id="total-orgs">32</div>
          <div class="kpi-subvalue">trabajando en la región</div>
        </div>
        <div class="kpi-card">
          <i class="fas fa-exclamation-triangle kpi-icon"></i>
          <div class="kpi-title">Operaciones en marcha</div>
          <div class="kpi-value" id="priority-operations">1</div>
          <div class="kpi-subvalue">Operación Relámpago Catatumbo</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div id="map"></div>
        <div class="filters-container">
          <div class="filter-group">
            <label class="filter-label">Municipios: </label>
            <div class="multiselect-container" id="municipality-multiselect">
              <div class="multiselect-dropdown">Seleccionar municipios...</div>
              <div class="multiselect-options"></div>
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Grupos Armados: </label>
            <div id="groups-filter">
              <div class="severity-buttons">
                <button class="group-button selected" data-value="delictivo"><i class="fas fa-users"></i> G.A.D.</button>
                <button class="group-button selected" data-value="eln"><i class="fas fa-flag"></i> ELN</button>
                <button class="group-button selected" data-value="farc"><i class="fas fa-fist-raised"></i> FARC</button>
                <button class="group-button selected" data-value="dfarc"><i class="fas fa-people-group"></i> D-FARC</button>
                <button class="group-button selected" data-value="paramilitares"><i class="fas fa-shield-alt"></i> Paramilitares</button>
              </div>
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Territorio Mínimo (km²): </label>
            <input type="range" id="territory-slider" min="0" max="22000" value="0" class="range-slider">
            <div class="range-values">
              <span id="territory-min">0 km²</span>
              <span id="territory-max">22,000 km²</span>
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Priorización: </label>
            <select class="filter-select" id="priority-select">
              <option value="all">Todas</option>
              <option value="1">Prioridad 1</option>
              <option value="2">Prioridad 2</option>
              <option value="3">Prioridad 3</option>
              <option value="4">Prioridad 4</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Cantidad de Grupos: </label>
            <select class="filter-select" id="group-count-select">
              <option value="all">Todos</option>
              <option value="1">1 grupo</option>
              <option value="2">2 grupos</option>
              <option value="3">3 grupos</option>
              <option value="4">4 grupos</option>
              <option value="5">5 grupos</option>
            </select>
          </div>
        </div>
      </div>

      <h2 class="section-title">Análisis por Grupo Armado</h2>
      <div class="sectoral-grid" id="gane-grid">
        <!-- Se llenará dinámicamente con JavaScript -->
      </div>

      <h2 class="section-title">Visualización de Datos</h2>
      <div class="charts-container">
        <div class="chart-box">
          <h3 class="chart-title">Distribución de Grupos Armados</h3>
          <canvas id="groups-distribution-chart"></canvas>
        </div>
        <div class="chart-box">
          <h3 class="chart-title">Territorio Controlado por Municipio (km²)</h3>
          <canvas id="territory-chart"></canvas>
        </div>
        <div class="chart-box">
          <h3 class="chart-title">Grupos Armados por Municipio</h3>
          <canvas id="groups-per-municipality-chart"></canvas>
        </div>
        <div class="chart-box">
          <h3 class="chart-title">Distribución por Cantidad de Grupos</h3>
          <canvas id="groups-count-chart"></canvas>
        </div>
        <div class="chart-box">
          <h3 class="chart-title">Organizaciones Humanitarias por Municipio</h3>
          <canvas id="humanitarian-orgs-chart"></canvas>
        </div>
        <div class="chart-box">
          <h3 class="chart-title">Población Afectada por Municipio</h3>
          <canvas id="affected-population-chart"></canvas>
        </div>
      </div>

      <!-- Mensajes clave (al final) -->
      <h2 class="section-title">Mensajes Clave</h2>
      <div class="message-container">
        <div class="message-grid">
          <div class="key-message alert">
            <h3>
              <div class="message-icon alert"><i class="fas fa-exclamation-triangle"></i></div>
              Concentración de Grupos Armados
            </h3>
            <p>2 municipios (Indígena Bolivariano Guajira y Jesús María Semprúm) presentan simultáneamente 4 grupos armados diferentes, aumentando significativamente el riesgo para la población civil y la complejidad de cualquier intervención humanitaria o de seguridad.</p>
          </div>
          <div class="key-message warning">
            <h3>
              <div class="message-icon warning"><i class="fas fa-chart-line"></i></div>
              Expansión del ELN
            </h3>
            <p>El ELN muestra una presencia significativa en 8 municipios, controlando 59,496 km² (86% del territorio bajo influencia de GANE), evidenciando su creciente dominio y capacidad operativa en la región fronteriza con Colombia.</p>
          </div>
          <div class="key-message info">
            <h3>
              <div class="message-icon info"><i class="fas fa-user-shield"></i></div>
              Operación Relámpago del Catatumbo
            </h3>
            <p>La reciente operación militar (enero 2025) responde a los enfrentamientos entre grupos armados en la región fronteriza, aunque organizaciones como FundaRedes han señalado que podría intensificar la presencia y poder de estos grupos en ciertos territorios.</p>
          </div>
          <div class="key-message success">
            <h3>
              <div class="message-icon success"><i class="fas fa-map-marked-alt"></i></div>
              Priorización Territorial
            </h3>
            <p>El 70% del territorio controlado por GANE (48,060 km²) se concentra en solo 3 municipios: Jesús María Semprúm, Machiques de Perijá e Indígena Bolivariano Guajira, lo que permitiría focalizar acciones de seguridad y protección en estas áreas clave.</p>
          </div>
          <div class="key-message info">
            <h3>
              <div class="message-icon info"><i class="fas fa-hand-holding-heart"></i></div>
              Impacto en Acción Humanitaria
            </h3>
            <p>La presencia de grupos armados afecta directamente las operaciones humanitarias, limitando el acceso a comunidades vulnerables. En municipios como Jesús María Semprúm e Indígena Bolivariano Guajira, los actores humanitarios deben negociar acceso seguro mientras mantienen su neutralidad, lo que reduce la eficacia y alcance de la asistencia.</p>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="footer-logo">
          <img src="https://images4.imagebam.com/f2/74/67/MEZQJH3_o.PNG" alt="Logo OCHA">
        </div>
        <div class="footer-info">
          <div class="footer-title">Análisis Grupos Armados No Estatales (GANE) 2025</div>
          <div class="footer-details">
            <span>OCHA Venezuela</span> · 
            <span>Mayo 2025</span> · 
            <span class="footer-source">Fuentes: Dashboard OCHA, FundaRedes, Crisis Group, InSight Crime, HRW</span>
          </div>
        </div>
        <div class="footer-links">
          <a href="#" class="footer-link"><i class="fas fa-file-pdf"></i> Informe</a>
          <a href="#" class="footer-link"><i class="fas fa-envelope"></i> Contacto</a>
        </div>
      </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script type="text/javascript">
      // Datos de municipios y grupos armados (actualizados con nombres correctos)
      const municipalData = [
        {
          nombre: "Cabimas",
          territorio: 0, // No especificado
          poblacion: 253123,
          prioridad: 4,
          orgHumanitarias: 3,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Catatumbo",
          territorio: 4875,
          poblacion: 40702,
          prioridad: 2,
          orgHumanitarias: 12,
          grupos: {
            delictivo: false,
            eln: true,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Colón",
          territorio: 3295,
          poblacion: 128729,
          prioridad: 3,
          orgHumanitarias: 12,
          grupos: {
            delictivo: false,
            eln: true,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Francisco Javier Pulgar",
          territorio: 721,
          poblacion: 41205,
          prioridad: 3,
          orgHumanitarias: 6,
          grupos: {
            delictivo: false,
            eln: true,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Indígena Bolivariano Guajira",
          territorio: 8776,
          poblacion: 65545,
          prioridad: 1,
          orgHumanitarias: 30,
          grupos: {
            delictivo: true,
            eln: true,
            farc: true,
            dfarc: true,
            paramilitares: false
          }
        },
        {
          nombre: "Jesús María Semprúm",
          territorio: 21172,
          poblacion: 32481,
          prioridad: 1,
          orgHumanitarias: 25,
          grupos: {
            delictivo: false,
            eln: true,
            farc: true,
            dfarc: true,
            paramilitares: true
          }
        },
        {
          nombre: "La Cañada de Urdaneta",
          territorio: 1841,
          poblacion: 87726,
          prioridad: 3,
          orgHumanitarias: 8,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Lagunillas",
          territorio: 0, // En blanco
          poblacion: 158642,
          prioridad: 4,
          orgHumanitarias: 4,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Machiques de Perijá",
          territorio: 17172,
          poblacion: 122734,
          prioridad: 2,
          orgHumanitarias: 16,
          grupos: {
            delictivo: true,
            eln: true,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Mara",
          territorio: 2006,
          poblacion: 207221,
          prioridad: 1,
          orgHumanitarias: 20,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Maracaibo",
          territorio: 1200,
          poblacion: 1752602,
          prioridad: 3,
          orgHumanitarias: 32,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Miranda",
          territorio: 2006,
          poblacion: 45145,
          prioridad: 4,
          orgHumanitarias: 5,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Rosario de Perijá",
          territorio: 3485,
          poblacion: 85006,
          prioridad: 1,
          orgHumanitarias: 15,
          grupos: {
            delictivo: false,
            eln: true,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "San Francisco",
          territorio: 167,
          poblacion: 478484,
          prioridad: 4,
          orgHumanitarias: 7,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Santa Rita",
          territorio: 521,
          poblacion: 102724,
          prioridad: 4,
          orgHumanitarias: 6,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        },
        {
          nombre: "Simón Bolívar",
          territorio: 236,
          poblacion: 64321,
          prioridad: 4,
          orgHumanitarias: 3,
          grupos: {
            delictivo: true,
            eln: false,
            farc: false,
            dfarc: false,
            paramilitares: false
          }
        }
      ];

      // Nombres y colores de los grupos - usando paleta OCHA
      const COLORS = {
        delictivo: '#F36D25',     // Naranja OCHA
        eln: '#1F69B3',           // Azul OCHA
        farc: '#009959',          // Verde OCHA
        dfarc: '#FFC107',         // Amarillo OCHA
        paramilitares: '#E56A54'  // Rojo OCHA
      };

      const GRUPO_NOMBRES = {
        delictivo: 'Grupos Armados Delictivo',
        eln: 'Ejército De Liberación Nacional (ELN)',
        farc: 'Fuerzas Armadas Revolucionarias de Colombia (FARC)',
        dfarc: 'Disidencias FARC (D-FARC)',
        paramilitares: 'Grupos paramilitares o sin identificar'
      };

      const GRUPO_NOMBRES_CORTOS = {
        delictivo: 'G.A. Delictivo',
        eln: 'ELN',
        farc: 'FARC',
        dfarc: 'D-FARC',
        paramilitares: 'Paramilitares'
      };

      // Coordenadas para el mapa (actualizadas)
const coordinates = {
  "Cabimas": [10.39907, -71.45206],
  "Catatumbo": [9.0608, -72.2342],
  "Colón": [9.00098, -71.92683],
  "Francisco Javier Pulgar": [8.98627, -71.61992],
  "Indígena Bolivariano Guajira": [11.0891, -71.8531],
  "Jesús María Semprúm": [8.74546, -72.52560],
  "La Cañada de Urdaneta": [10.5471, -71.6434],
  "Lagunillas": [10.13008, -71.25946],
  "Machiques de Perijá": [10.0667, -72.5500],
  "Mara": [10.950629939379114, -71.74415588378908],
  "Maracaibo": [10.6427, -71.6125],
  "Miranda": [10.2992, -71.7494],
  "Rosario de Perijá": [10.3217, -72.3261],
  "San Francisco": [10.5614, -71.6502],
  "Santa Rita": [10.5337, -71.5065],
  "Simón Bolívar": [10.0975, -71.2942]
};

      // Estado de los filtros
      const state = {
        selectedMunicipalities: [],
        selectedGroups: {
          delictivo: true,
          eln: true,
          farc: true,
          dfarc: true,
          paramilitares: true
        },
        territoryMin: 0,
        groupCount: 'all',
        priority: 'all'
      };

      let map;
      let charts = {};

      document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
      });

      function initializeDashboard() {
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#444';
        Chart.defaults.font.size = 12;
        Chart.defaults.font.weight = 500;
        
        initializeMap();
        initializeFilters();
        updateDashboard();
      }

      function initializeMap() {
        if (!document.getElementById('map')) {
          console.error('Map container not found');
          return;
        }

        map = L.map("map", {
          center: [10.4, -71.9],
          zoom: 8,
          minZoom: 6,
          maxZoom: 12,
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "OCHA",
        }).addTo(map);

        // Crear leyenda de grupos armados
        const legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = '<h4>Leyenda</h4>';
            
            // Añadir leyenda para cada grupo
            Object.keys(COLORS).forEach(key => {
                div.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${COLORS[key]}"></div>
                        <div class="legend-label">${GRUPO_NOMBRES_CORTOS[key]}</div>
                    </div>
                `;
            });
            
            // Añadir leyenda para múltiples grupos
            div.innerHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9467BD"></div>
                    <div class="legend-label">Múltiples grupos</div>
                </div>
            `;
            
            return div;
        };

        legend.addTo(map);
      }

      function filterData() {
        return municipalData.filter(municipality => {
          // Filtrar por municipios seleccionados
          if (state.selectedMunicipalities.length > 0 && 
              !state.selectedMunicipalities.includes(municipality.nombre)) {
            return false;
          }

          // Filtrar por territorio mínimo
          if (municipality.territorio < state.territoryMin) {
            return false;
          }

          // Filtrar por priorización
          if (state.priority !== 'all' && 
              municipality.prioridad !== parseInt(state.priority)) {
            return false;
          }

          // Filtrar por grupos seleccionados
          const hasSelectedGroup = Object.entries(state.selectedGroups).some(([group, selected]) => {
            return selected && municipality.grupos[group];
          });
          if (!hasSelectedGroup) {
            return false;
          }

          // Filtrar por cantidad de grupos
          if (state.groupCount !== 'all') {
            const groupCount = Object.values(municipality.grupos).filter(Boolean).length;
            if (parseInt(state.groupCount) !== groupCount) {
              return false;
            }
          }

          return true;
        });
      }

      function updateDashboard() {
        const filteredData = filterData();
        updateMap(filteredData);
        updateGANEGrid(filteredData);
        updateCharts(filteredData);
        
        // Actualizar totales en KPIs
        updateKPIs(filteredData);
      }

      function updateKPIs(filteredData) {
        // Territorio total
        const totalTerritory = filteredData.reduce((sum, mun) => sum + mun.territorio, 0);
        document.getElementById('total-territory').textContent = totalTerritory.toLocaleString();
        
        // Número de municipios
        document.getElementById('total-municipalities').textContent = filteredData.length;
        
        // Población total
        const totalPopulation = filteredData.reduce((sum, mun) => sum + mun.poblacion, 0);
        document.getElementById('total-population').textContent = totalPopulation.toLocaleString();
        
        // Organizaciones humanitarias
        const maxOrgs = Math.max(...filteredData.map(mun => mun.orgHumanitarias));
        document.getElementById('total-orgs').textContent = maxOrgs;
      }

      function updateMap(filteredData) {
        if (!map) return;

        // Limpiar capas excepto el mapa base
        map.eachLayer(layer => {
          if (!(layer instanceof L.TileLayer)) {
            map.removeLayer(layer);
          }
        });

        // Solo considerar municipios con coordenadas y territorio > 0
        const validMunicipalities = filteredData.filter(mun => {
          return coordinates[mun.nombre] && (mun.territorio > 0 || mun.nombre === "Maracaibo");
        });

        if (validMunicipalities.length === 0) {
          console.warn('No hay municipios válidos para mostrar en el mapa');
          return;
        }

        const bounds = [];

        validMunicipalities.forEach(mun => {
          const coords = coordinates[mun.nombre];
          if (!coords) return;

          // Calcular el radio basado en el territorio - PUNTOS MUCHO MÁS GRANDES
          const territoryForRadius = mun.territorio || 1000; // Si no tiene territorio, usar un valor base
          const radiusBase = Math.sqrt(territoryForRadius) * 50; // Aumentado de 25 a 50
          const groupCount = Object.values(mun.grupos).filter(Boolean).length;
          const radius = radiusBase * (0.8 + (groupCount * 0.2)); // Aumentados los multiplicadores

          // Determinar el color basado en el grupo dominante o múltiples grupos
          let color;
          let fillOpacity = 0.7; // Mayor visibilidad
          
          if (groupCount > 1) {
            // Si hay múltiples grupos, usar color púrpura de OCHA
            color = '#9467BD';
          } else {
            // Encontrar el único grupo presente
            const presentGroup = Object.keys(mun.grupos).find(key => mun.grupos[key]);
            color = presentGroup ? COLORS[presentGroup] : '#6C757D';
          }

          // Crear círculo con borde más grueso
          const circle = L.circle(coords, {
            color: color,
            fillColor: color,
            fillOpacity: fillOpacity,
            radius: radius,
            weight: 3, // Borde más grueso para mejor visibilidad
          }).addTo(map);

          // Crear contenido del popup
          const popupContent = createPopupContent(mun);
          circle.bindPopup(popupContent, {
            maxWidth: 350,
            className: 'custom-popup'
          });

          // Eventos para interactividad
          circle.on('mouseover', function() {
            this.setStyle({
              fillOpacity: 0.9,
              weight: 4
            });
          });
          
          circle.on('mouseout', function() {
            this.setStyle({
              fillOpacity: fillOpacity,
              weight: 3
            });
          });

          bounds.push(coords);
        });

        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      }

      function createPopupContent(municipality) {
        const groupsPresent = Object.keys(municipality.grupos)
          .filter(key => municipality.grupos[key])
          .map(key => `<span class="tag tag-${key}">${GRUPO_NOMBRES_CORTOS[key]}</span>`)
          .join(' ');

        const groupCount = Object.values(municipality.grupos).filter(Boolean).length;
        
        // Añadir indicador de prioridad
        const priorityClass = `priority-${municipality.prioridad}`;
        const priorityLabel = `<div><span class="priority-indicator ${priorityClass}">${municipality.prioridad}</span> <strong>Prioridad ${municipality.prioridad}</strong></div>`;

        return `
          <div class="municipality-popup">
            <h3>${municipality.nombre}</h3>
            <div class="popup-stats">
              <div><strong>Población:</strong> ${municipality.poblacion.toLocaleString()} habitantes</div>
              <div><strong>Territorio GANE:</strong> ${municipality.territorio > 0 ? municipality.territorio.toLocaleString() + ' km²' : 'No disponible'}</div>
              <div><strong>Organizaciones humanitarias:</strong> ${municipality.orgHumanitarias}</div>
              ${priorityLabel}
              <div><strong>Cantidad de grupos:</strong> ${groupCount}</div>
              <div><strong>Grupos presentes:</strong><div style="margin-top: 8px;">${groupsPresent}</div></div>
            </div>
          </div>
        `;
      }

      function updateGANEGrid(filteredData) {
        const grid = document.getElementById('gane-grid');
        if (!grid) return;

        grid.innerHTML = '';

        // Calcular estadísticas por grupo
        const groupStats = {
          delictivo: {
            count: 0,
            territory: 0,
            population: 0,
            icon: 'users'
          },
          eln: {
            count: 0,
            territory: 0,
            population: 0,
            icon: 'flag'
          },
          farc: {
            count: 0,
            territory: 0,
            population: 0,
            icon: 'fist-raised'
          },
          dfarc: {
            count: 0,
            territory: 0,
            population: 0,
            icon: 'people-group'
          },
          paramilitares: {
            count: 0,
            territory: 0,
            population: 0,
            icon: 'shield-alt'
          }
        };

        filteredData.forEach(mun => {
          Object.keys(mun.grupos).forEach(group => {
            if (mun.grupos[group]) {
              groupStats[group].count++;
              groupStats[group].territory += mun.territorio;
              groupStats[group].population += mun.poblacion;
            }
          });
        });

        // Crear tarjetas para cada grupo
        Object.keys(groupStats).forEach(group => {
          const card = document.createElement('div');
          card.className = 'sector-card';

          const totalTerritory = calculateTotalTerritory(filteredData);
          const percentageTerritory = totalTerritory > 0 
            ? Math.round((groupStats[group].territory / totalTerritory) * 100) 
            : 0;
            
          const totalPopulation = filteredData.reduce((sum, mun) => sum + mun.poblacion, 0);
          const percentagePopulation = totalPopulation > 0
            ? Math.round((groupStats[group].population / totalPopulation) * 100)
            : 0;

          card.innerHTML = `
            <div class="sector-header">
              <div class="sector-icon" style="background-color: ${COLORS[group]}">
                <i class="fas fa-${groupStats[group].icon}"></i>
              </div>
              <div class="sector-title">${GRUPO_NOMBRES_CORTOS[group]}</div>
            </div>
            <div class="sector-stats">
              <div class="stat-row">
                <span class="stat-label">Municipios:</span>
                <span class="stat-value">${groupStats[group].count}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Territorio:</span>
                <span class="stat-value">${groupStats[group].territory.toLocaleString()} km²</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">% del territorio:</span>
                <span class="stat-value">${percentageTerritory}%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Población afectada:</span>
                <span class="stat-value">${groupStats[group].population.toLocaleString()}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">% de población:</span>
                <span class="stat-value">${percentagePopulation}%</span>
              </div>
            </div>
          `;

          grid.appendChild(card);
        });
      }

      function calculateTotalTerritory(data) {
        return data.reduce((sum, mun) => sum + mun.territorio, 0);
      }

      function updateCharts(filteredData) {
        updateGroupsDistributionChart(filteredData);
        updateTerritoryChart(filteredData);
        updateGroupsPerMunicipalityChart(filteredData);
        updateGroupsCountChart(filteredData);
        updateHumanitarianOrgsChart(filteredData);
        updateAffectedPopulationChart(filteredData);
      }

      function updateGroupsDistributionChart(filteredData) {
        const ctx = document.getElementById('groups-distribution-chart').getContext('2d');
        
        // Contar presencia por grupo
        const groupCounts = {
          delictivo: 0,
          eln: 0,
          farc: 0,
          dfarc: 0,
          paramilitares: 0
        };

        filteredData.forEach(mun => {
          Object.keys(groupCounts).forEach(group => {
            if (mun.grupos[group]) {
              groupCounts[group]++;
            }
          });
        });

        const data = {
          labels: Object.keys(groupCounts).map(key => GRUPO_NOMBRES_CORTOS[key]),
          datasets: [{
            data: Object.values(groupCounts),
            backgroundColor: Object.keys(groupCounts).map(key => COLORS[key]),
            borderWidth: 1
          }]
        };

        if (charts.groupsDistribution) {
          charts.groupsDistribution.destroy();
        }

        charts.groupsDistribution = new Chart(ctx, {
          type: 'pie',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  padding: 15,
                  font: {
                    size: 14
                  },
                  generateLabels: function(chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                      return data.labels.map((label, i) => {
                        const meta = chart.getDatasetMeta(0);
                        const style = meta.controller.getStyle(i);
                        
                        return {
                          text: `${label} (${data.datasets[0].data[i]})`,
                          fillStyle: data.datasets[0].backgroundColor[i],
                          strokeStyle: '#fff',
                          lineWidth: 2,
                          hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden,
                          index: i
                        };
                      });
                    }
                    return [];
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ${value} municipios (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      function updateTerritoryChart(filteredData) {
        const ctx = document.getElementById('territory-chart').getContext('2d');
        
        // Ordenar municipios por territorio (de mayor a menor)
        const sortedData = [...filteredData]
          .filter(mun => mun.territorio > 0)
          .sort((a, b) => b.territorio - a.territorio);

        const data = {
          labels: sortedData.map(mun => mun.nombre),
          datasets: [{
            label: 'Territorio (km²)',
            data: sortedData.map(mun => mun.territorio),
            backgroundColor: sortedData.map(mun => {
              // Determinar color basado en grupos presentes
              const groups = Object.keys(mun.grupos).filter(key => mun.grupos[key]);
              if (groups.length > 1) {
                return '#9467BD'; // Color para múltiples grupos
              } else if (groups.length === 1) {
                return COLORS[groups[0]];
              } else {
                return '#6C757D'; // Gris para ningún grupo
              }
            }),
            borderColor: '#fff',
            borderWidth: 1
          }]
        };

        if (charts.territory) {
          charts.territory.destroy();
        }

        charts.territory = new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  label: function(context) {
                    return `Territorio: ${context.raw.toLocaleString()} km²`;
                  },
                  afterLabel: function(context) {
                    const mun = sortedData[context.dataIndex];
                    const groups = Object.keys(mun.grupos)
                      .filter(key => mun.grupos[key])
                      .map(key => GRUPO_NOMBRES_CORTOS[key]);
                    
                    if (groups.length === 0) return 'Sin grupos identificados';
                    return `Grupos: ${groups.join(', ')}`;
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Territorio (km²)',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              y: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      function updateGroupsPerMunicipalityChart(filteredData) {
        const ctx = document.getElementById('groups-per-municipality-chart').getContext('2d');
        
        // Ordenar municipios para mejor visualización
        const sortedData = [...filteredData].sort((a, b) => {
          const countA = Object.values(a.grupos).filter(Boolean).length;
          const countB = Object.values(b.grupos).filter(Boolean).length;
          return countB - countA; // De mayor a menor cantidad de grupos
        });
        
        // Preparar datos para gráfico de barras apiladas
        const municipalityNames = sortedData.map(mun => mun.nombre);
        
        // Crear datasets para cada grupo
        const datasets = Object.keys(COLORS).map(group => {
          return {
            label: GRUPO_NOMBRES_CORTOS[group],
            data: sortedData.map(mun => mun.grupos[group] ? 1 : 0),
            backgroundColor: COLORS[group],
            borderColor: '#fff',
            borderWidth: 1
          };
        });

        const data = {
          labels: municipalityNames,
          datasets: datasets
        };

        if (charts.groupsPerMunicipality) {
          charts.groupsPerMunicipality.destroy();
        }

        charts.groupsPerMunicipality = new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  afterTitle: function(context) {
                    const mun = sortedData[context[0].dataIndex];
                    const count = Object.values(mun.grupos).filter(Boolean).length;
                    return `Total: ${count} ${count === 1 ? 'grupo' : 'grupos'}`;
                  }
                }
              }
            },
            scales: {
              x: {
                stacked: true,
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              },
              y: {
                stacked: true,
                max: 5,
                min: 0,
                ticks: {
                  stepSize: 1
                },
                title: {
                  display: true,
                  text: 'Número de grupos',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                }
              }
            }
          }
        });
      }

      function updateGroupsCountChart(filteredData) {
        const ctx = document.getElementById('groups-count-chart').getContext('2d');
        
        // Contar municipios por número de grupos presentes
        const groupsCount = [0, 0, 0, 0, 0, 0]; // Índice 0 no se usa
        
        filteredData.forEach(mun => {
          const count = Object.values(mun.grupos).filter(Boolean).length;
          groupsCount[count]++;
        });
        
        // Eliminar el índice 0
        groupsCount.shift();
        
        // Usar colores más contrastantes
        const colors = [
          '#4CAF50', // Verde
          '#FFC107', // Amarillo
          '#FF9800', // Naranja
          '#F44336', // Rojo
          '#9C27B0'  // Púrpura
        ];
        
        const data = {
          labels: ['1 grupo', '2 grupos', '3 grupos', '4 grupos', '5 grupos'],
          datasets: [{
            data: groupsCount,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 2
          }]
        };

        if (charts.groupsCount) {
          charts.groupsCount.destroy();
        }

        charts.groupsCount = new Chart(ctx, {
          type: 'doughnut', // Cambiado de pie a doughnut para variedad visual
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '40%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  padding: 15,
                  font: {
                    size: 14
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ${value} municipios (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      function updateHumanitarianOrgsChart(filteredData) {
        const ctx = document.getElementById('humanitarian-orgs-chart').getContext('2d');
        
        // Ordenar municipios por número de organizaciones (de mayor a menor)
        const sortedData = [...filteredData]
          .sort((a, b) => b.orgHumanitarias - a.orgHumanitarias)
          .slice(0, 10); // Mostrar solo los 10 con más organizaciones
        
        const data = {
          labels: sortedData.map(mun => mun.nombre),
          datasets: [{
            label: 'Organizaciones Humanitarias',
            data: sortedData.map(mun => mun.orgHumanitarias),
            backgroundColor: '#59B9E3', // Color azul claro OCHA
            borderColor: '#1F69B3', // Color azul oscuro OCHA
            borderWidth: 1
          }]
        };

        if (charts.humanitarianOrgs) {
          charts.humanitarianOrgs.destroy();
        }

        charts.humanitarianOrgs = new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  label: function(context) {
                    const value = context.raw;
                    return `Organizaciones: ${value}`;
                  },
                  afterLabel: function(context) {
                    const mun = sortedData[context.dataIndex];
                    return `Prioridad: ${mun.prioridad}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Número de organizaciones',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                ticks: {
                  stepSize: 5
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });
      }

      function updateAffectedPopulationChart(filteredData) {
        const ctx = document.getElementById('affected-population-chart').getContext('2d');
        
        // Ordenar municipios por población (de mayor a menor)
        const sortedData = [...filteredData]
          .sort((a, b) => b.poblacion - a.poblacion)
          .slice(0, 10); // Mostrar solo los 10 con más población
        
        const data = {
          labels: sortedData.map(mun => mun.nombre),
          datasets: [{
            label: 'Población',
            data: sortedData.map(mun => mun.poblacion),
            backgroundColor: sortedData.map(mun => {
              // Color basado en la prioridad
              return mun.prioridad === 1 ? '#E56A54' : 
                     mun.prioridad === 2 ? '#F36D25' : 
                     mun.prioridad === 3 ? '#FFC107' : '#009959';
            }),
            borderColor: '#fff',
            borderWidth: 1
          }]
        };

        if (charts.affectedPopulation) {
          charts.affectedPopulation.destroy();
        }

        charts.affectedPopulation = new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  label: function(context) {
                    return `Población: ${context.raw.toLocaleString()} habitantes`;
                  },
                  afterLabel: function(context) {
                    const mun = sortedData[context.dataIndex];
                    const groupCount = Object.values(mun.grupos).filter(Boolean).length;
                    return [
                      `Prioridad: ${mun.prioridad}`,
                      `Grupos presentes: ${groupCount}`
                    ];
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Población',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });
      }

      function initializeFilters() {
        // Inicializar multiselect de municipios
        initializeMunicipalityFilter();
        
        // Inicializar filtro de grupos
        initializeGroupsFilter();
        
        // Inicializar slider de territorio
        initializeTerritorySlider();
        
        // Inicializar select de cantidad de grupos
        initializeGroupCountFilter();
        
        // Inicializar select de priorización
        initializePriorityFilter();
      }

      function initializeMunicipalityFilter() {
        const container = document.getElementById('municipality-multiselect');
        if (!container) return;
        
        const dropdown = container.querySelector('.multiselect-dropdown');
        const optionsContainer = container.querySelector('.multiselect-options');
        
        // Añadir opción "Seleccionar todos"
        const selectAllDiv = document.createElement('div');
        selectAllDiv.className = 'multiselect-option';
        selectAllDiv.innerHTML = `
          <input type="checkbox" id="select-all-municipalities">
          <span>Seleccionar todos</span>
        `;
        
        const selectAllCheckbox = selectAllDiv.querySelector('input');
        selectAllCheckbox.addEventListener('change', () => {
          const allCheckboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
          
          if (selectAllCheckbox.checked) {
            allCheckboxes.forEach(cb => {
              cb.checked = true;
              if (cb.id !== 'select-all-municipalities') {
                state.selectedMunicipalities.push(cb.value);
              }
            });
          } else {
            allCheckboxes.forEach(cb => { cb.checked = false; });
            state.selectedMunicipalities = [];
          }
          
          updateSelectedText(container);
          updateDashboard();
        });
        
        optionsContainer.appendChild(selectAllDiv);
        
        // Añadir opciones para cada municipio
        municipalData.forEach(mun => {
          const option = document.createElement('div');
          option.className = 'multiselect-option';
          option.innerHTML = `
            <input type="checkbox" value="${mun.nombre}">
            <span>${mun.nombre}</span>
          `;
          
          const checkbox = option.querySelector('input');
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              state.selectedMunicipalities.push(mun.nombre);
            } else {
              state.selectedMunicipalities = state.selectedMunicipalities.filter(name => name !== mun.nombre);
              // Desmarcar "Seleccionar todos" si algún municipio no está seleccionado
              selectAllCheckbox.checked = false;
            }
            
            updateSelectedText(container);
            updateDashboard();
          });
          
          optionsContainer.appendChild(option);
        });
        
        // Mostrar/ocultar opciones al hacer clic en el dropdown
        dropdown.addEventListener('click', () => {
          optionsContainer.style.display = optionsContainer.style.display === 'none' ? 'block' : 'none';
        });
        
        // Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
          if (!container.contains(e.target)) {
            optionsContainer.style.display = 'none';
          }
        });
        
        updateSelectedText(container);
      }

      function updateSelectedText(container) {
        const dropdown = container.querySelector('.multiselect-dropdown');
        
        if (state.selectedMunicipalities.length === 0) {
          dropdown.textContent = 'Todos los municipios';
        } else if (state.selectedMunicipalities.length === municipalData.length) {
          dropdown.textContent = 'Todos los municipios';
        } else if (state.selectedMunicipalities.length <= 2) {
          dropdown.textContent = state.selectedMunicipalities.join(', ');
        } else {
          dropdown.textContent = `${state.selectedMunicipalities.length} municipios seleccionados`;
        }
      }

      function initializeGroupsFilter() {
        const container = document.getElementById('groups-filter');
        if (!container) return;
        
        const buttons = container.querySelectorAll('.group-button');
        
        buttons.forEach(button => {
          button.addEventListener('click', () => {
            const group = button.getAttribute('data-value');
            button.classList.toggle('selected');
            state.selectedGroups[group] = button.classList.contains('selected');
            
            updateDashboard();
          });
        });
      }

      function initializeTerritorySlider() {
        const slider = document.getElementById('territory-slider');
        const minValue = document.getElementById('territory-min');
        
        if (!slider || !minValue) return;
        
        slider.addEventListener('input', () => {
          state.territoryMin = parseInt(slider.value);
          minValue.textContent = `${state.territoryMin.toLocaleString()} km²`;
          
          updateDashboard();
        });
      }

      function initializeGroupCountFilter() {
        const select = document.getElementById('group-count-select');
        if (!select) return;
        
        select.addEventListener('change', () => {
          state.groupCount = select.value;
          updateDashboard();
        });
      }
      
      function initializePriorityFilter() {
        const select = document.getElementById('priority-select');
        if (!select) return;
        
        select.addEventListener('change', () => {
          state.priority = select.value;
          updateDashboard();
        });
      }

      function formatNumber(num) {
        if (!num && num !== 0) return "0";
        return num.toLocaleString("es-VE");
      }

      // Funciones de exportación e impresión
      window.exportData = function() {
        const exportData = {
          municipalData: municipalData,
          filteredData: filterData(),
          state: state
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "dashboard-gane-data.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      window.printDashboard = function() {
        window.print();
      }
    </script>
  </body>
</html>
